<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>礼品使用说明</title>
    <link rel="stylesheet" href="css/weui.min.css" />
    <link rel="stylesheet" href="css/jquery-weui.min.css">
    <link rel="stylesheet" href="css/style.css?v=1.1" />
</head>
<body>
<div class="weui-msg" style="padding-top: 25px; display: none" id="success">
    <div class="weui-msg__text-area" style="text-align: left">
        <p class="weui-msg__title" style="margin-bottom: 10px; font-size: 18px">
            礼品使用说明：
        </p>
        <p class="weui-msg__desc" style="font-size: 16px;  white-space: pre-wrap" id="intro"></p>
    </div>
</div>

<div class="weui-msg" id="done" style="display: none">
    <div class="weui-msg__icon-area"><i class="weui-icon-warn weui-icon_msg-primary"></i></div>
    <div class="weui-msg__text-area">
        <h2 class="weui-msg__title">对不起！奖品已发放完。</h2>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script src="js/jquery-weui.min.js"></script>
<script>
let ajaxUrl = '/sicd/api/claim';
let getUrlParam= function(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]);
    return null;
}
let getCode = function (callback) {
    if(sessionStorage.getItem('openId') && sessionStorage.getItem('openId') !== 'undefined') {
        queryPrize(callback)
        return false;
    }
    let code = getUrlParam('code');
    let local = window.location.href;
    let APPID = 'wx0abb5ad71c9c182d';
    if (code == null || code === '') {
        window.location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + APPID + '&redirect_uri=' + encodeURIComponent(local) + '&response_type=code&scope=snsapi_base&state=#wechat_redirect'
    } else {
        getOpenId(code, callback)
    }
}
let getOpenId = function(code, callback){
    $.showLoading();
    $.ajax({
        type: 'GET',
        dataType: 'json',
        url: ajaxUrl + '/appinfo/getOpenid?code=' + code,
        data: {},
        success: function (res) {
            if(res.response === 'error'){
                $.toast(res.error, 'forbidden');
            }else{
                sessionStorage.setItem("openId", res.ok);
                queryPrize(callback)
            }
        }
    });
}

let queryPrize = function(){
    $.ajax({
        type: 'GET',
        dataType: 'json',
        url: ajaxUrl + '/appinfo/queryPrizeReceive?openId=' + sessionStorage.openId + '&prizeType=1',
        data: {},
        success: function (res) {
            $.hideLoading();
            if(res.response === 'error'){
                $.toast(res.error, 'forbidden');
            }else{
                if(res.ok.id){
                    $('#success').show()
                    $('#intro').html(res.ok.prizeExplain)
                }else{
                    $('#done').show()
                }
            }
        }
    });
}

getCode()

</script>
</body>
</html>